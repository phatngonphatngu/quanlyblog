<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tr√¨nh ƒêƒÉng b√†i Blogger</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        /* Lo·∫°i b·ªè c√°c l·ªõp @apply, thay v√†o ƒë√≥ s·ª≠ d·ª•ng class tr·ª±c ti·∫øp trong HTML */
        
        /* Style cho Quill Editor ƒë·ªÉ n√≥ l·∫•p ƒë·∫ßy kh√¥ng gian */
        #editor-wrapper {
            display: flex;
            flex-direction: column;
            flex-grow: 1;
            min-height: 0; /* Fix cho flexbox overflow */
        }
        .ql-container.ql-snow {
            flex-grow: 1;
            overflow-y: auto;
            border-bottom-left-radius: 0.75rem; /* 12px */
            border-bottom-right-radius: 0.75rem; /* 12px */
        }
        .ql-toolbar.ql-snow {
            border-top-left-radius: 0.75rem; /* 12px */
            border-top-right-radius: 0.75rem; /* 12px */
        }
    </style>
</head>
<body class="bg-gray-200">

    <div id="auth-container" class="min-h-screen flex items-center justify-center p-4">
        <div class="text-center bg-white p-8 rounded-xl shadow-lg max-w-sm w-full">
            <h1 class="text-2xl font-bold text-gray-900 mb-2">Tr√¨nh ƒêƒÉng b√†i Blogger</h1>
            <p id="auth-message" class="mb-4 text-gray-600">ƒêang t·∫£i c·∫•u h√¨nh...</p>
            <button id="login-button" class="w-full px-6 py-2 rounded-lg font-semibold text-white transition duration-200 bg-blue-600 hover:bg-blue-700 inline-flex items-center justify-center" disabled>
                <svg class="w-5 h-5 mr-2" viewBox="0 0 48 48"><path fill="#FFC107" d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12c0-6.627,5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24s8.955,20,20,20s20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z"></path><path fill="#FF3D00" d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"></path><path fill="#4CAF50" d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36c-5.222,0-9.619-3.317-11.283-7.946l-6.522,5.025C9.505,39.556,16.227,44,24,44z"></path><path fill="#1976D2" d="M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.574l6.19,5.238C42.022,35.244,44,30.036,44,24C44,22.659,43.862,21.35,43.611,20.083z"></path></svg>
                ƒêƒÉng nh·∫≠p v·ªõi Google
            </button>
        </div>
    </div>

    <div id="app-container" class="hidden">
        <div id="editor-fullscreen-container" class="fixed inset-0 bg-gray-100 p-4 sm:p-6 md:p-8 flex flex-col" style="z-index: 50;">
            <div id="editor-header" class="flex-shrink-0 flex flex-col sm:flex-row items-start sm:items-center justify-between mb-4 gap-4">
                <p class="flex-shrink-0">Blog: <strong id="blog-name" class="text-blue-600"></strong></p>
                <div class="flex items-center gap-4 w-full sm:w-auto justify-end">
                    <button id="logout-button" class="text-sm text-gray-600 hover:text-red-600">ƒêƒÉng xu·∫•t</button>
                    <button id="publish-button" class="px-8 py-3 rounded-lg font-semibold text-white transition duration-200 bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 shadow-lg text-lg flex-shrink-0">
                        üöÄ ƒêƒÉng b√†i
                    </button>
                </div>
            </div>
            <div id="editor-main" class="flex-grow bg-white rounded-xl shadow-lg p-4 sm:p-6 flex flex-col overflow-y-auto min-h-0">
                <textarea id="post-title-input" class="w-full text-2xl sm:text-3xl font-bold border-none focus:ring-0 p-2 mb-4 bg-transparent resize-none overflow-hidden flex-shrink-0" placeholder="Nh·∫≠p ti√™u ƒë·ªÅ..." rows="1"></textarea>
                
                <div id="labels-wrapper" class="relative mb-4 flex-shrink-0">
                    <div id="labels-input-container" class="flex flex-wrap items-center gap-2 p-2 border border-gray-300 rounded-lg bg-white">
                        <input id="labels-input" type="text" placeholder="Th√™m nh√£n..." class="flex-grow border-none focus:ring-0 p-1">
                    </div>
                    <div id="labels-suggestions" class="absolute w-full bg-white border border-gray-300 rounded-lg mt-1 max-h-40 overflow-y-auto shadow-lg hidden" style="z-index: 60;"></div>
                </div>

                <div id="editor-wrapper">
                     <div id="editor"></div>
                </div>
            </div>
             <div id="status-message" class="mt-4 text-center font-medium p-4 rounded-lg flex-shrink-0"></div>
        </div>
    </div>

    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client"></script>

    <script type="text/javascript">
        const ALLOWED_EMAIL = 'phatngonphatngu@gmail.com'; // S·ª≠a th√†nh email c·ªßa b·∫°n n·∫øu c·∫ßn
        const SCOPES = 'https://www.googleapis.com/auth/blogger https://www.googleapis.com/auth/userinfo.email';

        // DOM Elements
        const loginButton = document.getElementById('login-button');
        const logoutButton = document.getElementById('logout-button');
        const publishButton = document.getElementById('publish-button');
        const authContainer = document.getElementById('auth-container');
        const appContainer = document.getElementById('app-container');
        const blogNameElement = document.getElementById('blog-name');
        const postTitleInput = document.getElementById('post-title-input');
        const labelsWrapper = document.getElementById('labels-wrapper');
        const labelsInputContainer = document.getElementById('labels-input-container');
        const labelsInput = document.getElementById('labels-input');
        const labelsSuggestions = document.getElementById('labels-suggestions');
        const statusMessage = document.getElementById('status-message');
        const authMessage = document.getElementById('auth-message');
        
        let tokenClient;
        let gapiInited = false;
        let gisInited = false;
        let quill;
        let selectedBlogId = null;
        let allAvailableLabels = [];
        let selectedLabels = new Set();

        function setStatus(message, type = 'info') {
            statusMessage.innerHTML = message;
            statusMessage.className = 'mt-4 text-center font-medium p-4 rounded-lg flex-shrink-0';
            switch (type) {
                case 'success': statusMessage.classList.add('text-green-800', 'bg-green-100'); break;
                case 'error': statusMessage.classList.add('text-red-800', 'bg-red-100'); break;
                case 'info': statusMessage.classList.add('text-blue-800', 'bg-blue-100'); break;
            }
        }
        
        async function initializeGapiClient() {
            await gapi.client.load('oauth2', 'v2');
            gapiInited = true;
            maybeEnableButtons();
        }

        async function tokenCallback(tokenResponse) {
            if (tokenResponse.error) {
                setStatus('L·ªói x√°c th·ª±c. Vui l√≤ng th·ª≠ l·∫°i.', 'error');
                return;
            }
            gapi.client.setToken(tokenResponse);
            await fetchUserInfoAndBlogs();
        }

        function initializeGisClient(clientId) {
            if (!clientId) {
                setStatus('Kh√¥ng th·ªÉ t·∫£i c·∫•u h√¨nh Client ID t·ª´ server.', 'error');
                return;
            }
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: clientId,
                scope: SCOPES,
                callback: tokenCallback,
            });
            gisInited = true;
            maybeEnableButtons();
        }

        function maybeEnableButtons() {
            if (gapiInited && gisInited) {
                loginButton.disabled = false;
                authMessage.textContent = 'Vui l√≤ng ƒëƒÉng nh·∫≠p b·∫±ng t√†i kho·∫£n Google.';
            }
        }

        async function fetchConfigAndInitialize() {
            try {
                const response = await fetch('/api/config');
                const responseText = await response.text();
                if (!response.ok) throw new Error(`Server tr·∫£ v·ªÅ l·ªói ${response.status}.`);
                const config = JSON.parse(responseText);
                gapi.load('client', initializeGapiClient);
                initializeGisClient(config.clientId);
            } catch (error) {
                console.error('Failed to fetch config:', error);
                let displayError = error.message;
                if (error instanceof SyntaxError) {
                    displayError = "L·ªói server. Vui l√≤ng ki·ªÉm tra log tr√™n Render.";
                }
                setStatus(displayError, 'error');
                authMessage.textContent = 'L·ªói k·∫øt n·ªëi ho·∫∑c c·∫•u h√¨nh server.';
            }
        }
        
        function updateUI(isLoggedIn) {
            if (isLoggedIn) {
                authContainer.classList.add('hidden');
                appContainer.classList.remove('hidden');
            } else {
                authContainer.classList.remove('hidden');
                appContainer.classList.add('hidden');
                blogNameElement.textContent = '';
                postTitleInput.value = '';
                selectedLabels.clear();
                renderSelectedLabels();
                if(quill) quill.setText('');
            }
        }

        function handleLogout() {
            const token = gapi.client.getToken();
            if (token) google.accounts.oauth2.revoke(token.access_token, () => gapi.client.setToken(''));
            updateUI(false);
        }

        async function fetchAndStoreLabels(blogId) {
            const token = gapi.client.getToken();
            if (!token) return;
            try {
                const response = await fetch('/api/labels', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ accessToken: token.access_token, blogId: blogId })
                });
                const data = await response.json();
                if (!response.ok) throw new Error(data.error || 'L·ªói kh√¥ng x√°c ƒë·ªãnh.');
                allAvailableLabels = data.labels || [];
            } catch (err) {
                console.error("L·ªói khi t·∫£i nh√£n:", err);
                setStatus(`L·ªói khi t·∫£i nh√£n: ${err.message}`, 'error');
            }
        }

        async function fetchUserInfoAndBlogs() {
            try {
                const profileResponse = await gapi.client.oauth2.userinfo.get();
                const userEmail = profileResponse.result.email;

                if (userEmail.toLowerCase() !== ALLOWED_EMAIL.toLowerCase()) {
                    setStatus(`Truy c·∫≠p b·ªã t·ª´ ch·ªëi.`, 'error');
                    setTimeout(handleLogout, 3000); 
                    return;
                }

                const token = gapi.client.getToken();
                if (!token) throw new Error("Kh√¥ng t√¨m th·∫•y token x√°c th·ª±c.");

                const backendResponse = await fetch('/api/blogs', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ accessToken: token.access_token })
                });
                const blogData = await backendResponse.json();
                if (!backendResponse.ok) throw new Error(`L·ªói t·ª´ server: ${blogData.error?.message}`);

                const blogs = blogData.items;
                if (blogs && blogs.length > 0) {
                    selectedBlogId = blogs[0].id;
                    blogNameElement.textContent = blogs[0].name;
                    await fetchAndStoreLabels(selectedBlogId);
                    updateUI(true);
                    setStatus('');
                } else {
                    setStatus('Kh√¥ng t√¨m th·∫•y blog n√†o cho t√†i kho·∫£n n√†y.', 'error');
                    handleLogout();
                }
            } catch (err) {
                console.error('L·ªói khi l·∫•y d·ªØ li·ªáu:', err);
                setStatus(`L·ªói: ${err.message}`, 'error');
                handleLogout();
            }
        }

        function renderSelectedLabels() {
            labelsInputContainer.querySelectorAll('.label-pill').forEach(pill => pill.remove());
            selectedLabels.forEach(label => {
                const pill = document.createElement('span');
                pill.className = 'flex items-center gap-2 bg-blue-100 text-blue-800 text-sm font-medium px-2.5 py-1 rounded-full label-pill';
                pill.textContent = label;
                const removeBtn = document.createElement('button');
                removeBtn.className = 'bg-blue-200 hover:bg-blue-300 rounded-full p-0.5 leading-none';
                removeBtn.innerHTML = '&times;';
                removeBtn.onclick = () => {
                    selectedLabels.delete(label);
                    renderSelectedLabels();
                };
                pill.appendChild(removeBtn);
                labelsInputContainer.insertBefore(pill, labelsInput);
            });
        }
        
        function showLabelSuggestions(query) {
            labelsSuggestions.innerHTML = '';
            if (!query) {
                labelsSuggestions.classList.add('hidden');
                return;
            }
            const filtered = allAvailableLabels.filter(l => l.toLowerCase().includes(query.toLowerCase()) && !selectedLabels.has(l));
            
            if (filtered.length > 0) {
                filtered.forEach(label => {
                    const item = document.createElement('div');
                    item.className = 'px-4 py-2 cursor-pointer hover:bg-gray-100 suggestion-item';
                    item.textContent = label;
                    item.onclick = () => {
                        selectedLabels.add(label);
                        renderSelectedLabels();
                        labelsInput.value = '';
                        labelsSuggestions.classList.add('hidden');
                    };
                    labelsSuggestions.appendChild(item);
                });
                labelsSuggestions.classList.remove('hidden');
            } else {
                labelsSuggestions.classList.add('hidden');
            }
        }

        async function publishPost() {
            const title = postTitleInput.value.trim();
            const content = quill.root.innerHTML;
            const token = gapi.client.getToken();

            if (!selectedBlogId || !title || content === '<p><br></p>') {
                setStatus('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß ti√™u ƒë·ªÅ v√† n·ªôi dung.', 'error');
                return;
            }
            if (!token) {
                setStatus('Phi√™n ƒëƒÉng nh·∫≠p ƒë√£ h·∫øt h·∫°n.', 'error'); return;
            }

            setStatus('ƒêang ƒëƒÉng b√†i...', 'info');
            publishButton.disabled = true;

            try {
                const response = await fetch('/api/publish', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        blogId: selectedBlogId,
                        title: title,
                        content: content,
                        accessToken: token.access_token,
                        labels: Array.from(selectedLabels)
                    })
                });
                const result = await response.json();
                if (!response.ok) throw new Error(result.error?.message || JSON.stringify(result));
                
                setStatus(`ƒêƒÉng b√†i th√†nh c√¥ng! <a href="${result.url}" target="_blank" class="text-blue-600 underline">Xem b√†i vi·∫øt</a>`, 'success');
                postTitleInput.value = '';
                quill.setText('');
                selectedLabels.clear();
                renderSelectedLabels();
            } catch (err) {
                setStatus(`L·ªói khi ƒëƒÉng b√†i: ${err.message}`, 'error');
            } finally {
                publishButton.disabled = false;
            }
        }

        function initializeQuill() {
             quill = new Quill('#editor', {
                modules: { toolbar: [
                    [{ 'header': [1, 2, 3, false] }],
                    ['bold', 'italic', 'underline', 'strike'],
                    ['link', 'image', 'video', 'blockquote', 'code-block'],
                    [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                    [{ 'align': [] }],
                    ['clean']
                ]},
                placeholder: 'So·∫°n n·ªôi dung c·ªßa b·∫°n t·∫°i ƒë√¢y...',
                theme: 'snow'
            });
        }

        // Event Listeners
        loginButton.addEventListener('click', () => tokenClient.requestAccessToken({ prompt: 'consent' }));
        logoutButton.addEventListener('click', handleLogout);
        publishButton.addEventListener('click', publishPost);
        
        labelsInput.addEventListener('input', () => showLabelSuggestions(labelsInput.value));
        labelsInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' || e.key === ',') {
                e.preventDefault();
                const newLabel = labelsInput.value.trim();
                if (newLabel && !selectedLabels.has(newLabel)) {
                    selectedLabels.add(newLabel);
                    renderSelectedLabels();
                }
                labelsInput.value = '';
                labelsSuggestions.classList.add('hidden');
            }
        });
        document.addEventListener('click', (e) => {
            if (!labelsWrapper.contains(e.target)) {
                labelsSuggestions.classList.add('hidden');
            }
        });
        postTitleInput.addEventListener('input', () => {
            postTitleInput.style.height = 'auto';
            postTitleInput.style.height = (postTitleInput.scrollHeight) + 'px';
        });

        window.onload = () => {
            fetchConfigAndInitialize();
            initializeQuill();
        };
    </script>
</body>
</html>
