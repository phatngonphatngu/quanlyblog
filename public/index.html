<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trình Đăng bài Blogger</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .form-input, .form-textarea, .form-select {
            @apply w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200;
        }
        .btn {
            @apply px-6 py-2 rounded-lg font-semibold text-white transition duration-200;
        }
        .btn-primary {
            @apply bg-blue-600 hover:bg-blue-700;
        }
        .btn-secondary {
            @apply bg-gray-500 hover:bg-gray-600;
        }
        .btn-danger {
            @apply bg-red-600 hover:bg-red-700;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 md:p-8 max-w-4xl">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-900">Trình Soạn Thảo và Đăng Bài Blogger</h1>
            <p class="text-gray-600 mt-2">Đăng bài lên blog của bạn một cách nhanh chóng mà không cần vào trang quản trị.</p>
        </header>

        <!-- Authentication Section -->
        <div id="auth-container" class="text-center bg-white p-8 rounded-xl shadow-md">
            <p class="mb-4">Vui lòng đăng nhập bằng tài khoản Google để bắt đầu.</p>
            <button id="login-button" class="btn btn-primary inline-flex items-center">
                <svg class="w-5 h-5 mr-2" viewBox="0 0 48 48" width="48px" height="48px"><path fill="#FFC107" d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12c0-6.627,5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24s8.955,20,20,20s20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z"></path><path fill="#FF3D00" d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"></path><path fill="#4CAF50" d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36c-5.222,0-9.619-3.317-11.283-7.946l-6.522,5.025C9.505,39.556,16.227,44,24,44z"></path><path fill="#1976D2" d="M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.574l6.19,5.238C42.022,35.244,44,30.036,44,24C44,22.659,43.862,21.35,43.611,20.083z"></path></svg>
                Đăng nhập với Google
            </button>
        </div>

        <!-- Main Application -->
        <div id="app-container" class="hidden">
            <div class="bg-white p-8 rounded-xl shadow-md">
                <div class="flex justify-between items-center mb-6">
                    <p>Đã đăng nhập với: <strong id="user-email" class="text-blue-600"></strong></p>
                    <button id="logout-button" class="btn btn-danger">Đăng xuất</button>
                </div>

                <!-- Blog Selector -->
                <div class="mb-6">
                    <label for="blog-selector" class="block mb-2 font-semibold">1. Chọn Blog để đăng bài:</label>
                    <select id="blog-selector" class="form-select"></select>
                </div>

                <!-- Post Editor -->
                <div class="mb-6">
                    <label for="post-title" class="block mb-2 font-semibold">2. Tiêu đề bài viết:</label>
                    <input type="text" id="post-title" class="form-input" placeholder="Nhập tiêu đề tại đây...">
                </div>
                <div class="mb-6">
                    <label for="post-content" class="block mb-2 font-semibold">3. Nội dung bài viết (hỗ trợ HTML):</label>
                    <textarea id="post-content" class="form-textarea" rows="15" placeholder="Soạn nội dung của bạn... Bạn có thể dùng các thẻ HTML như <b>, <i>, <p>, <img>..."></textarea>
                </div>

                <!-- Action Button -->
                <div class="text-center">
                    <button id="publish-button" class="btn btn-primary text-lg">
                        🚀 Đăng bài ngay
                    </button>
                </div>
            </div>
            <div id="status-message" class="mt-4 text-center font-medium"></div>
        </div>
    </div>

    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client"></script>

    <script type="text/javascript">
        // =========================================================================
        // BƯỚC 1: THAY THẾ CÁC GIÁ TRỊ NÀY
        // Lấy các giá trị này từ Google Cloud Console của bạn
        // Hướng dẫn: https://developers.google.com/blogger/docs/3.0/using#APIKey
        // =========================================================================
        const CLIENT_ID = 'YOUR_CLIENT_ID.apps.googleusercontent.com'; // <-- THAY THẾ BẰNG CLIENT ID CỦA BẠN
        const API_KEY = 'YOUR_API_KEY'; // <-- THAY THẾ BẰNG API KEY CỦA BẠN

        // Scope cho phép ứng dụng quản lý bài đăng trên Blogger
        const SCOPES = 'https://www.googleapis.com/auth/blogger';

        // DOM Elements
        const loginButton = document.getElementById('login-button');
        const logoutButton = document.getElementById('logout-button');
        const publishButton = document.getElementById('publish-button');
        const authContainer = document.getElementById('auth-container');
        const appContainer = document.getElementById('app-container');
        const userEmailElement = document.getElementById('user-email');
        const blogSelector = document.getElementById('blog-selector');
        const postTitle = document.getElementById('post-title');
        const postContent = document.getElementById('post-content');
        const statusMessage = document.getElementById('status-message');

        let tokenClient;
        let gapiInited = false;
        let gisInited = false;

        // Load GAPI (Google API Client Library)
        function gapiLoaded() {
            gapi.load('client', initializeGapiClient);
        }

        // Initialize GAPI client
        async function initializeGapiClient() {
            await gapi.client.init({
                apiKey: API_KEY,
                discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/blogger/v3/rest'],
            });
            gapiInited = true;
            maybeEnableButtons();
        }

        // Load GIS (Google Identity Services)
        function gisLoaded() {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: SCOPES,
                callback: tokenCallback,
            });
            gisInited = true;
            maybeEnableButtons();
        }

        // Enable buttons when both libraries are loaded
        function maybeEnableButtons() {
            if (gapiInited && gisInited) {
                loginButton.disabled = false;
            }
        }

        // Callback function after successful authentication
        async function tokenCallback(tokenResponse) {
            if (tokenResponse.error) {
                console.error('Authentication error:', tokenResponse.error);
                setStatus('Lỗi xác thực. Vui lòng thử lại.', 'error');
                return;
            }
            gapi.client.setToken(tokenResponse);
            await fetchUserInfoAndBlogs();
        }

        // Fetch user info and their blogs
        async function fetchUserInfoAndBlogs() {
            try {
                // Fetch user profile to get email
                const profileResponse = await gapi.client.oauth2.userinfo.get();
                userEmailElement.textContent = profileResponse.result.email;

                // Fetch user's blogs
                const response = await gapi.client.blogger.blogs.listByUser({ userId: 'self' });
                const blogs = response.result.items;
                
                blogSelector.innerHTML = ''; // Clear previous options
                if (blogs && blogs.length > 0) {
                    blogs.forEach(blog => {
                        const option = document.createElement('option');
                        option.value = blog.id;
                        option.textContent = blog.name;
                        blogSelector.appendChild(option);
                    });
                    updateUI(true); // Show the app
                } else {
                    setStatus('Không tìm thấy blog nào cho tài khoản này.', 'error');
                    handleLogout();
                }
            } catch (err) {
                console.error('Error fetching data:', err);
                setStatus(`Lỗi: ${err.result.error.message}`, 'error');
                handleLogout();
            }
        }

        // Handle login
        function handleLogin() {
            tokenClient.requestAccessToken({ prompt: 'consent' });
        }

        // Handle logout
        function handleLogout() {
            const token = gapi.client.getToken();
            if (token !== null) {
                google.accounts.oauth2.revoke(token.access_token, () => {
                    gapi.client.setToken('');
                    updateUI(false);
                });
            }
        }

        // Publish a new post
        async function publishPost() {
            const blogId = blogSelector.value;
            const title = postTitle.value.trim();
            const content = postContent.value.trim();

            if (!blogId) {
                setStatus('Vui lòng chọn một blog.', 'error');
                return;
            }
            if (!title || !content) {
                setStatus('Tiêu đề và nội dung không được để trống.', 'error');
                return;
            }

            setStatus('Đang đăng bài...', 'info');
            publishButton.disabled = true;

            try {
                const postBody = {
                    kind: 'blogger#post',
                    blog: {
                        id: blogId
                    },
                    title: title,
                    content: content
                };

                const response = await gapi.client.blogger.posts.insert({
                    blogId: blogId,
                    resource: postBody
                });
                
                setStatus(`Đăng bài thành công! <a href="${response.result.url}" target="_blank" class="text-blue-600 underline">Xem bài viết</a>`, 'success');
                postTitle.value = '';
                postContent.value = '';

            } catch (err) {
                console.error('Error publishing post:', err);
                setStatus(`Lỗi khi đăng bài: ${err.result.error.message}`, 'error');
            } finally {
                publishButton.disabled = false;
            }
        }

        // Update UI based on login state
        function updateUI(isLoggedIn) {
            if (isLoggedIn) {
                authContainer.classList.add('hidden');
                appContainer.classList.remove('hidden');
            } else {
                authContainer.classList.remove('hidden');
                appContainer.classList.add('hidden');
                userEmailElement.textContent = '';
                blogSelector.innerHTML = '';
                postTitle.value = '';
                postContent.value = '';
                setStatus('');
            }
        }

        // Set status message
        function setStatus(message, type = 'info') {
            statusMessage.innerHTML = message;
            statusMessage.className = 'mt-4 text-center font-medium'; // Reset classes
            switch (type) {
                case 'success':
                    statusMessage.classList.add('text-green-600');
                    break;
                case 'error':
                    statusMessage.classList.add('text-red-600');
                    break;
                case 'info':
                    statusMessage.classList.add('text-blue-600');
                    break;
            }
        }

        // Event Listeners
        loginButton.addEventListener('click', handleLogin);
        logoutButton.addEventListener('click', handleLogout);
        publishButton.addEventListener('click', publishPost);

        // Load the libraries
        window.onload = () => {
            gapiLoaded();
            gisLoaded();
        };

    </script>
</body>
</html>
