<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trình Đăng bài Blogger</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .form-input, .form-textarea, .form-select { @apply w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200; }
        .btn { @apply px-6 py-2 rounded-lg font-semibold text-white transition duration-200; }
        .btn-primary { @apply bg-blue-600 hover:bg-blue-700; }
        .btn-danger { @apply bg-red-600 hover:bg-red-700; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 md:p-8 max-w-4xl">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-900">Trình Soạn Thảo và Đăng Bài Blogger</h1>
            <p class="text-gray-600 mt-2">Đăng bài lên blog của bạn một cách nhanh chóng mà không cần vào trang quản trị.</p>
        </header>

        <!-- Authentication Section -->
        <div id="auth-container" class="text-center bg-white p-8 rounded-xl shadow-md">
            <p id="auth-message" class="mb-4">Đang tải cấu hình, vui lòng đợi...</p>
            <button id="login-button" class="btn btn-primary inline-flex items-center" disabled>
                <svg class="w-5 h-5 mr-2" viewBox="0 0 48 48"><path fill="#FFC107" d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12c0-6.627,5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24s8.955,20,20,20s20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z"></path><path fill="#FF3D00" d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"></path><path fill="#4CAF50" d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36c-5.222,0-9.619-3.317-11.283-7.946l-6.522,5.025C9.505,39.556,16.227,44,24,44z"></path><path fill="#1976D2" d="M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.574l6.19,5.238C42.022,35.244,44,30.036,44,24C44,22.659,43.862,21.35,43.611,20.083z"></path></svg>
                Đăng nhập với Google
            </button>
        </div>

        <!-- Main Application -->
        <div id="app-container" class="hidden">
            <!-- Content giữ nguyên như trước -->
        </div>
        <div id="status-message" class="mt-4 text-center font-medium p-4"></div>
    </div>

    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client"></script>

    <script type="text/javascript">
        // Cấu hình không còn ở đây nữa
        const ALLOWED_EMAIL = 'phatngonphatng@gmail.com';
        const SCOPES = 'https://www.googleapis.com/auth/blogger';

        // DOM Elements
        const loginButton = document.getElementById('login-button');
        const authMessage = document.getElementById('auth-message');
        // ... các DOM elements khác giữ nguyên
        
        let tokenClient;
        let gapiInited = false;
        let gisInited = false;
        let API_KEY = ''; // Sẽ được lấy từ backend

        // Khởi tạo GAPI client (Sửa đổi: Lấy API_KEY từ backend)
        async function initializeGapiClient() {
            // Chúng ta không cần API_KEY cho việc xác thực, chỉ cần cho việc đăng bài.
            // Vì vậy, ta có thể bỏ qua việc init với API_KEY ở đây.
            // Backend sẽ tự xử lý API_KEY.
            await gapi.client.load('blogger', 'v3');
            gapiInited = true;
            maybeEnableButtons();
        }

        // Khởi tạo GIS client (Sửa đổi: Nhận Client ID từ tham số)
        function initializeGisClient(clientId) {
            if (!clientId) {
                setStatus('Không thể tải cấu hình Client ID từ server.', 'error');
                return;
            }
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: clientId,
                scope: SCOPES,
                callback: tokenCallback,
            });
            gisInited = true;
            maybeEnableButtons();
        }

        function maybeEnableButtons() {
            if (gapiInited && gisInited) {
                loginButton.disabled = false;
                authMessage.textContent = 'Vui lòng đăng nhập bằng tài khoản Google để bắt đầu.';
            }
        }

        // === HÀM MỚI: Tải cấu hình từ backend ===
        async function fetchConfigAndInitialize() {
            try {
                const response = await fetch('/api/config');
                if (!response.ok) {
                    throw new Error('Lỗi khi tải cấu hình từ server.');
                }
                const config = await response.json();
                
                // Khởi tạo các thư viện Google với Client ID nhận được
                gapi.load('client', initializeGapiClient);
                google.accounts.id.initialize({
                    client_id: config.clientId,
                    callback: () => {}
                });
                initializeGisClient(config.clientId);

            } catch (error) {
                console.error('Failed to fetch config:', error);
                setStatus('Không thể kết nối tới server để lấy cấu hình. Vui lòng tải lại trang.', 'error');
                authMessage.textContent = 'Lỗi kết nối server.';
            }
        }

        // Các hàm còn lại (tokenCallback, fetchUserInfoAndBlogs, publishPost,...) giữ nguyên như trước
        // ...

        // Sửa đổi hàm khởi chạy khi tải trang
        window.onload = () => {
            fetchConfigAndInitialize();
        };

    </script>
</body>
</html>
